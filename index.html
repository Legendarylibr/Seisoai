<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <link rel="shortcut icon" href="/vite.svg" />
    <link rel="apple-touch-icon" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Seiso AI</title>
    
    <!-- Security Headers with proper CSP for development -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://js.stripe.com https://checkout.stripe.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https: blob:; connect-src 'self' http://localhost:3001 http://localhost:3000 http://localhost:5173 https://api.fal.ai https://api.mainnet-beta.solana.com https://solana-api.projectserum.com https://rpc.ankr.com https://solana-mainnet.g.alchemy.com https://mainnet.helius-rpc.com https://api.devnet.solana.com https: wss:; frame-src 'self' https://js.stripe.com https://checkout.stripe.com; object-src 'none'; base-uri 'self'; form-action 'self';" />
    <meta http-equiv="X-Content-Type-Options" content="nosniff" />
    <meta http-equiv="X-XSS-Protection" content="1; mode=block" />
    
    <!-- Enhanced wallet conflict resolution - must run first -->
    <script>
      (function() {
        'use strict';
        
        // Prevent multiple executions
        if (window.__walletConflictResolutionSetup) {
          return;
        }
        window.__walletConflictResolutionSetup = true;
        
        // Note: We no longer block evmAsk.js - we handle redefinition gracefully instead
        
        // Store original methods
        const originalDefineProperty = Object.defineProperty;
        const originalDefineProperties = Object.defineProperties;
        
        // GRACEFUL defineProperty override - silently handle redefinition attempts
        Object.defineProperty = function(obj, prop, descriptor) {
          // Handle ethereum property redefinition gracefully
          if (prop === 'ethereum' && obj === window) {
            // If ethereum already exists, silently return it (don't redefine)
            // This prevents errors from evmAsk.js and other wallet extensions
            if (window.ethereum) {
              // Modern wallets consolidate via providers array, so check if we can enhance
              const existingEthereum = window.ethereum;
              const newValue = descriptor.value;
              
              // If new value is a provider and existing doesn't have providers array yet
              if (newValue && typeof newValue === 'object' && newValue.request && 
                  existingEthereum && !existingEthereum.providers && 
                  (newValue.isMetaMask || newValue.isRabby || newValue.isCoinbaseWallet)) {
                try {
                  // Try to set up providers array if possible
                  if (descriptor.configurable !== false && existingEthereum !== newValue) {
                    const providers = [existingEthereum];
                    if (!providers.some(p => (p.isMetaMask && newValue.isMetaMask) || 
                                              (p.isRabby && newValue.isRabby) || 
                                              (p.isCoinbaseWallet && newValue.isCoinbaseWallet))) {
                      providers.push(newValue);
                    }
                    
                    // Only update if we have multiple providers
                    if (providers.length > 1) {
                      Object.defineProperty(window, 'ethereum', {
                        value: {
                          providers: providers,
                          request: function(...args) {
                            return providers[0].request(...args);
                          },
                          on: function(...args) {
                            providers.forEach(p => p.on?.(...args));
                          },
                          removeListener: function(...args) {
                            providers.forEach(p => p.removeListener?.(...args));
                          },
                          addListener: function(...args) {
                            providers.forEach(p => p.addListener?.(...args));
                          }
                        },
                        configurable: true,
                        enumerable: true,
                        writable: true
                      });
                      return window.ethereum;
                    }
                  }
                } catch (e) {
                  // Silent fail - just use existing
                }
              }
              
              // Return existing without error (silent success)
              return existingEthereum;
            }
            
            // First definition - allow it
            try {
              return originalDefineProperty.call(this, obj, prop, descriptor);
            } catch (error) {
              // If it fails, check if ethereum was set another way
              if (window.ethereum) {
                return window.ethereum;
              }
              throw error;
            }
          }
          
          // Prevent originalDefineProperty conflicts
          if (prop === 'originalDefineProperty' && obj === window) {
            if (window.originalDefineProperty) {
              console.warn('üõ°Ô∏è Wallet conflict prevented: originalDefineProperty already exists');
              return window.originalDefineProperty;
            }
          }
          
          // Prevent other common wallet conflicts
          if (prop === 'defineProperty' && obj === Object) {
            if (window.originalDefineProperty) {
              console.warn('üõ°Ô∏è Wallet conflict prevented: defineProperty already exists');
              return window.originalDefineProperty;
            }
          }
          
          try {
            return originalDefineProperty.call(this, obj, prop, descriptor);
          } catch (error) {
            // If it's a redefinition error, just return the existing property
            if (error.message.includes('Cannot redefine property')) {
              console.warn('üõ°Ô∏è Property redefinition prevented:', prop);
              return obj[prop];
            }
            throw error;
          }
        };
        
        // Enhanced defineProperties override
        Object.defineProperties = function(obj, props) {
          if (obj === window && props.ethereum) {
            if (window.ethereum) {
              console.warn('üõ°Ô∏è Wallet conflict prevented: ethereum property already exists (defineProperties)');
              return window;
            }
          }
          return originalDefineProperties.call(this, obj, props);
        };
        
        // Store original functions
        window.originalDefineProperty = originalDefineProperty;
        window.originalDefineProperties = originalDefineProperties;
        
        // Handle uncaught errors - silently catch wallet redefinition errors
        window.addEventListener('error', function(event) {
          const error = event.error;
          const message = error?.message || '';
          const stack = error?.stack || '';
          const filename = event.filename || '';
          
          // Silently catch ethereum property redefinition errors (harmless)
          if (message.includes('Cannot redefine property: ethereum') ||
              (message.includes('Cannot redefine property') && message.includes('ethereum')) ||
              (filename && filename.includes('evmAsk.js') && message.includes('defineProperty'))) {
            event.preventDefault();
            event.stopPropagation();
            event.stopImmediatePropagation();
            // Silent - don't log to avoid console noise
            return false;
          }
        }, true); // Use capture phase to catch earlier
        
        // ULTRA-AGGRESSIVE: Override ALL error handling
        const originalOnError = window.onerror;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;
        
        // Filter out harmless wallet redefinition errors from console
        console.error = function(...args) {
          const message = args[0]?.toString?.() || '';
          if (message.includes('Cannot redefine property: ethereum') ||
              (message.includes('evmAsk.js') && message.includes('defineProperty'))) {
            // Silent - these are harmless
            return;
          }
          return originalConsoleError.apply(this, args);
        };
        
        // Filter out wallet conflict warnings
        console.warn = function(...args) {
          const message = args[0]?.toString?.() || '';
          if (message.includes('Cannot redefine property: ethereum')) {
            return; // Silent
          }
          return originalConsoleWarn.apply(this, args);
        };
        
        // Override the global error handler - silently catch wallet redefinition errors
        window.onerror = function(message, source, lineno, colno, error) {
          if (message && (
              message.includes('Cannot redefine property: ethereum') ||
              ((source && source.includes('evmAsk')) && message.includes('defineProperty'))
            )) {
            // Silent - return true to prevent default error handling
            return true;
          }
          if (originalOnError) {
            return originalOnError.call(this, message, source, lineno, colno, error);
          }
          return false;
        };
        
        // Handle unhandled promise rejections - silently catch wallet redefinition errors
        window.addEventListener('unhandledrejection', function(event) {
          const reason = event.reason;
          const message = reason?.message || '';
          const stack = reason?.stack || '';
          
          // Silently prevent wallet-related promise rejections from redefinition
          if (message.includes('Cannot redefine property: ethereum') ||
              (message.includes('evmAsk.js') && message.includes('defineProperty'))) {
            event.preventDefault();
            event.stopPropagation();
            // Silent - don't log
            return false;
          }
        });
        
        // Note: We no longer aggressively block script injection - we handle redefinition gracefully
        
        console.log('üõ°Ô∏è Enhanced wallet conflict resolution initialized');
      })();
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>