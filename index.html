<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Seiso AI</title>
    
    <!-- Security Headers (CSP removed to allow wallet extensions) -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff" />
    <meta http-equiv="X-XSS-Protection" content="1; mode=block" />
    
    <!-- Enhanced wallet conflict resolution - must run first -->
    <script>
      (function() {
        'use strict';
        
        // Prevent multiple executions
        if (window.__walletConflictResolutionSetup) {
          return;
        }
        window.__walletConflictResolutionSetup = true;
        
        // Store original methods
        const originalDefineProperty = Object.defineProperty;
        const originalDefineProperties = Object.defineProperties;
        
        // Enhanced defineProperty override
        Object.defineProperty = function(obj, prop, descriptor) {
          // Prevent ethereum property redefinition
          if (prop === 'ethereum' && obj === window) {
            if (window.ethereum && descriptor.value) {
              console.warn('üõ°Ô∏è Wallet conflict prevented: ethereum property already exists');
              return window.ethereum;
            }
            
            // Allow first definition but make it configurable
            try {
              return originalDefineProperty.call(this, obj, prop, {
                ...descriptor,
                configurable: true,
                enumerable: true
              });
            } catch (error) {
              console.warn('üõ°Ô∏è Ethereum property definition failed, using fallback');
              window.ethereum = descriptor.value || {};
              return window.ethereum;
            }
          }
          
          // Prevent originalDefineProperty conflicts
          if (prop === 'originalDefineProperty' && obj === window) {
            if (window.originalDefineProperty) {
              console.warn('üõ°Ô∏è Wallet conflict prevented: originalDefineProperty already exists');
              return window.originalDefineProperty;
            }
          }
          
          // Prevent other common wallet conflicts
          if (prop === 'defineProperty' && obj === Object) {
            if (window.originalDefineProperty) {
              console.warn('üõ°Ô∏è Wallet conflict prevented: defineProperty already exists');
              return window.originalDefineProperty;
            }
          }
          
          try {
            return originalDefineProperty.call(this, obj, prop, descriptor);
          } catch (error) {
            // If it's a redefinition error, just return the existing property
            if (error.message.includes('Cannot redefine property')) {
              console.warn('üõ°Ô∏è Property redefinition prevented:', prop);
              return obj[prop];
            }
            throw error;
          }
        };
        
        // Enhanced defineProperties override
        Object.defineProperties = function(obj, props) {
          if (obj === window && props.ethereum) {
            if (window.ethereum) {
              console.warn('üõ°Ô∏è Wallet conflict prevented: ethereum property already exists (defineProperties)');
              return window;
            }
          }
          return originalDefineProperties.call(this, obj, props);
        };
        
        // Store original functions
        window.originalDefineProperty = originalDefineProperty;
        window.originalDefineProperties = originalDefineProperties;
        
        // Global error handler for wallet conflicts
        const originalError = console.error;
        console.error = function(...args) {
          const message = args[0]?.toString?.() || '';
          
          // Filter out wallet conflict errors
          if (message.includes('Cannot redefine property: ethereum') ||
              message.includes('originalDefineProperty') ||
              message.includes('evmAsk.js') ||
              message.includes('inject')) {
            console.warn('üõ°Ô∏è Wallet conflict error filtered:', message);
            return;
          }
          
          originalError.apply(console, args);
        };
        
        // Handle uncaught errors
        window.addEventListener('error', function(event) {
          const error = event.error;
          const message = error?.message || '';
          const stack = error?.stack || '';
          const filename = event.filename || '';
          
          // Prevent ethereum property redefinition errors
          if (message.includes('Cannot redefine property: ethereum') ||
              message.includes('originalDefineProperty') ||
              message.includes('evmAsk.js') ||
              stack.includes('evmAsk.js') ||
              filename.includes('evmAsk.js') ||
              message.includes('Cannot redefine property')) {
            event.preventDefault();
            event.stopPropagation();
            console.warn('üõ°Ô∏è Wallet conflict error prevented:', message);
            return false;
          }
        });
        
        // Handle unhandled promise rejections
        window.addEventListener('unhandledrejection', function(event) {
          const reason = event.reason;
          const message = reason?.message || '';
          const stack = reason?.stack || '';
          
          // Prevent wallet-related promise rejections
          if (message.includes('Cannot redefine property: ethereum') ||
              message.includes('originalDefineProperty') ||
              message.includes('evmAsk.js') ||
              stack.includes('evmAsk.js') ||
              message.includes('Cannot redefine property')) {
            event.preventDefault();
            event.stopPropagation();
            console.warn('üõ°Ô∏è Wallet conflict promise rejection prevented:', message);
            return false;
          }
        });
        
        // Intercept script loading to prevent problematic wallet scripts
        const originalCreateElement = document.createElement;
        document.createElement = function(tagName) {
          const element = originalCreateElement.call(this, tagName);
          
          if (tagName.toLowerCase() === 'script') {
            const originalSetAttribute = element.setAttribute;
            element.setAttribute = function(name, value) {
              if (name === 'src' && typeof value === 'string') {
                // Block problematic wallet scripts
                if (value.includes('evmAsk.js') || 
                    value.includes('evmAsk') ||
                    (value.includes('wallet') && value.includes('inject'))) {
                  console.warn('üõ°Ô∏è Blocked problematic wallet script:', value);
                  return; // Don't set the src
                }
              }
              return originalSetAttribute.call(this, name, value);
            };
          }
          
          return element;
        };
        
        console.log('üõ°Ô∏è Enhanced wallet conflict resolution initialized');
      })();
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>